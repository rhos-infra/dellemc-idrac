---

- name: Execute Power Action '{{ power_action }}' On iDRAC
  community.general.redfish_command:
    category: Systems
    command: "{{ power_action }}"
    baseuri: "{{ inventory_hostname }}"
    username: "{{ ansible_user }}"
    password: "{{ ansible_password }}"
    timeout: "{{ idrac_timeout }}"
  register: power_action_result
  retries: "{{ task_retries }}"
  until:
    - "'EOF occurred in violation of protocol' not in power_action_result['msg']"

- name: Notify User That Playbook Doesn't Wait For iDRAC To Finsih Power Action
  ansible.builtin.set_stats:
    data:
      WARNING:
        - "This play does not wait until iDRAC {{ inventory_hostname }} completes the requested power action."
  when:
    - "'power_action' in host_play_variables"
    - power_action_result is changed
